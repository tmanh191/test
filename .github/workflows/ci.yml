name: CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  python-check:
    name: Python Syntax & Lint Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
    
    - name: Check Python syntax
      run: |
        python3 -m py_compile detector.py
        echo "✓ Python syntax check passed"
    
    - name: Install Python linters
      run: |
        pip install --upgrade pip
        pip install flake8 pylint
    
    - name: Run flake8
      run: |
        flake8 detector.py --max-line-length=120 --ignore=E501,W503 || true
        echo "✓ Flake8 check completed"
    
    - name: Run pylint (non-blocking)
      run: |
        pylint detector.py --disable=all --enable=E,F || true
        echo "✓ Pylint check completed"

  c-code-check:
    name: C Code Compilation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          clang \
          llvm \
          libbpf-dev \
          linux-headers-$(uname -r) \
          bpfcc-tools \
          python3-bpfcc
    
    - name: Check C syntax (basic)
      run: |
        # Basic syntax check using clang
        clang -fsyntax-only -I/usr/include/bpf -I/usr/src/linux-headers-$(uname -r)/include \
          -I/usr/src/linux-headers-$(uname -r)/include/uapi \
          -I/usr/src/linux-headers-$(uname -r)/include/generated/uapi \
          bpf.c 2>&1 | head -20 || echo "Note: Full compilation requires BCC runtime"
        echo "✓ C syntax check completed"

  bpf-compilation-check:
    name: BPF Program Compilation Check
    runs-on: ubuntu-latest
    # This job may fail if BCC is not fully available, but we try anyway
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install BCC
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bpfcc-tools \
          python3-bpfcc \
          libbpfcc \
          linux-headers-$(uname -r)
      continue-on-error: true
    
    - name: Test BPF compilation with Python
      run: |
        python3 << 'EOF'
        import sys
        try:
            from bcc import BPF
            print("✓ BCC import successful")
            
            # Try to compile BPF program (may fail without proper kernel support)
            try:
                b = BPF(src_file="bpf.c", cflags=["-Wno-macro-redefined"], debug=0)
                print("✓ BPF program compiled successfully")
            except Exception as e:
                print(f"⚠ BPF compilation warning: {e}")
                print("Note: This is expected in CI environment without full kernel support")
                sys.exit(0)  # Don't fail the build
        except ImportError as e:
            print(f"⚠ BCC not available: {e}")
            print("Note: BCC requires kernel support and may not be available in CI")
            sys.exit(0)  # Don't fail the build
        EOF
      continue-on-error: true

  file-structure-check:
    name: File Structure & Requirements Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check required files exist
      run: |
        echo "Checking required files..."
        test -f detector.py && echo "✓ detector.py exists" || (echo "✗ detector.py missing" && exit 1)
        test -f bpf.c && echo "✓ bpf.c exists" || (echo "✗ bpf.c missing" && exit 1)
        test -f bpf.h && echo "✓ bpf.h exists" || (echo "✗ bpf.h missing" && exit 1)
        test -f README.md && echo "✓ README.md exists" || (echo "✗ README.md missing" && exit 1)
        echo "✓ All required files present"
    
    - name: Check file permissions
      run: |
        if [ -x detector.py ]; then
          echo "✓ detector.py is executable"
        else
          echo "Note: detector.py is not executable (may need chmod +x)"
        fi
    
    - name: Validate Python shebang
      run: |
        if head -1 detector.py | grep -q "^#!/usr/bin/python3"; then
          echo "✓ Python shebang found"
        else
          echo "Note: No Python shebang found in detector.py"
        fi

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for common issues
      run: |
        echo "Checking for common code issues..."
        
        # Check for hardcoded paths
        if grep -r "/home/" . --exclude-dir=.git 2>/dev/null; then
          echo "⚠ Warning: Found hardcoded /home/ paths"
        fi
        
        # Check for TODO/FIXME comments
        echo "Checking for TODO/FIXME comments..."
        grep -r "TODO\|FIXME" . --exclude-dir=.git || echo "✓ No TODO/FIXME comments found"
        
        # Check file sizes
        echo "Checking file sizes..."
        find . -type f -name "*.py" -o -name "*.c" -o -name "*.h" | while read f; do
          size=$(wc -l < "$f")
          if [ $size -gt 1000 ]; then
            echo "⚠ Large file: $f ($size lines)"
          fi
        done
        
        echo "✓ Code quality checks completed"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [python-check, c-code-check, bpf-compilation-check, file-structure-check, code-quality]
    if: always()
    
    steps:
    - name: CI Status
      run: |
        echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Python Check | ${{ needs.python-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| C Code Check | ${{ needs.c-code-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| BPF Compilation | ${{ needs.bpf-compilation-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| File Structure | ${{ needs.file-structure-check.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Note: BPF compilation may show warnings in CI environment due to kernel requirements." >> $GITHUB_STEP_SUMMARY

